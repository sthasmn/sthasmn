<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ビデオ文章録画アプリ（文章自動生成版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal-content { background-color: #fefefe; color: #333; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; text-align: center; }
    .modal-buttons button { margin: 0 10px; }
    *:focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }
    #videoPreview, #videoPreviewTest, #deviceSelectionPreview { transform: scaleX(-1); background-color: #000; }
    .timer-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; z-index: 50; }
    #statusMessages { min-height: 4rem; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 flex flex-col items-center justify-center min-h-screen p-4 selection:bg-sky-500 selection:text-white">

<div id="appContainer" class="w-full max-w-2xl bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl space-y-6">

  <div id="nameSection" class="space-y-4">
    <h1 class="text-3xl font-bold text-sky-400 text-center">ビデオ文章録画アプリ</h1>
    <p id="nameSectionInstruction" class="text-slate-300 text-center">ステップ1：参加者番号または氏名を入力し、文章バッチを選択してください。</p>
    <div>
      <label for="userName" class="block text-sm font-medium text-sky-300 mb-1">参加者番号：</label>
      <input type="text" id="userName" name="userName" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="例：s2">
    </div>
    <div>
      <label for="sentenceBatch" class="block text-sm font-medium text-sky-300 mb-1">文章バッチを選択：</label>
      <select id="sentenceBatch" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
        <option value="">-- バッチを選択 --</option>
        <option value="1">文章バッチ１</option>
        <option value="2">文章バッチ２</option>
        <option value="3">文章バッチ３</option>
        <option value="4">文章バッチ４</option>
        <option value="5">文章バッチ５</option>
        <option value="6">文章バッチ６</option>
        <option value="7">文章バッチ７</option>
        <option value="8">文章バッチ８</option>
        <option value="9">文章バッチ９</option>
        <option value="10">文章バッチ１０</option>
      </select>
    </div>
    <div id="completedBatchesDisplay" class="text-sm text-slate-400 mt-2"></div>
    <button id="proceedToDeviceSetupButton" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition duration-150 ease-in-out" disabled>
      デバイス設定へ進む
    </button>
  </div>

  <div id="deviceSelectionSection" class="hidden space-y-4">
    <h2 class="text-2xl font-semibold text-sky-400 text-center">ステップ2：デバイス選択</h2>
    <p class="text-slate-300 text-center">使用するカメラとマイクを選択してください。デバイス一覧表示のために許可を求めることがあります。</p>
    <div class="w-full aspect-video bg-slate-900 rounded-lg overflow-hidden shadow-lg">
      <video id="deviceSelectionPreview" playsinline autoplay muted class="w-full h-full object-cover"></video>
    </div>
    <div>
      <label for="cameraSelect" class="block text-sm font-medium text-sky-300 mb-1">カメラ：</label>
      <select id="cameraSelect" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"></select>
    </div>
    <div>
      <label for="micSelect" class="block text-sm font-medium text-sky-300 mb-1">マイク：</label>
      <select id="micSelect" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"></select>
    </div>
    <button id="confirmDevicesAndTestButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out" disabled>
      デバイスを確認してテスト録画へ
    </button>
    <button id="backToNameSetupButton" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-opacity-50 transition duration-150 ease-in-out mt-2">
      戻る
    </button>
  </div>

  <div id="testRecordingSection" class="hidden space-y-4">
    <h2 class="text-2xl font-semibold text-sky-400 text-center">ステップ3：テスト録画</h2>
    <div class="bg-slate-700 p-4 rounded-lg shadow text-center">
      <p class="text-lg font-medium text-slate-100">読み上げてください： <span id="testSentenceDisplay" class="text-yellow-400">天気がいいから散歩しましょう。</span></p>
    </div>
    <div class="w-full aspect-video bg-slate-900 rounded-lg overflow-hidden shadow-lg relative">
      <video id="videoPreviewTest" playsinline autoplay muted class="w-full h-full object-cover"></video>
    </div>
    <button id="startStopTestButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">テスト録画開始</button>
    <button id="proceedToMainRecordingButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hidden mt-2">本番録画へ進む</button>
    <button id="backToDeviceSelectionButton" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md mt-2">
      デバイス選択へ戻る
    </button>
  </div>

  <div id="recordingSection" class="hidden space-y-4 relative">
    <h2 class="text-2xl font-semibold text-sky-400 text-center">本番録画</h2>
    <div id="sentenceDisplayContainer" class="bg-slate-700 p-6 rounded-lg shadow text-center min-h-[100px] flex items-center justify-center">
      <p id="sentenceToRead" class="text-xl md:text-2xl font-medium text-slate-100"></p>
    </div>
    <div class="w-full aspect-video bg-slate-900 rounded-lg overflow-hidden shadow-lg relative">
      <video id="videoPreview" playsinline autoplay muted class="w-full h-full object-cover"></video>
      <div id="timerDisplayContainer" class="hidden timer-display"><p id="timerText" class="text-6xl font-bold text-yellow-400"></p></div>
      <div id="recordingIndicator" class="hidden absolute top-3 right-3 w-4 h-4 bg-red-500 rounded-full animate-pulse z-10"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
      <button id="pauseResumeButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md" disabled>一時停止</button>
      <button id="redoButton" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md" disabled>やり直し</button>
      <button id="nextSentenceButton" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md">最初の文章から開始</button>
    </div>
    <p class="text-xs text-slate-400 text-center"><kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">Enter</kbd> または <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">Space</kbd> で次へ</p>
    <div class="bg-slate-700 p-4 rounded-lg shadow mt-4"> <p class="text-sm text-slate-300">参加者番号： <span id="displayName" class="font-medium text-sky-300"></span></p>
      <p class="text-sm text-slate-300">バッチ： <span id="displayBatchInfo" class="font-medium text-sky-300"></span></p>
      <p class="text-sm text-slate-300">バッチ内の文章数： <span id="totalSentencesDisplay" class="font-medium text-sky-300">0</span></p>
    </div>
  </div>

  <div id="completionMessageUi" class="hidden text-center space-y-3 p-6 bg-slate-700 rounded-lg shadow">
    <h2 class="text-2xl font-bold text-green-400">バッチ完了！</h2>
    <p class="text-slate-200">ファイルはローカルに保存されました。</p>
    <p id="completionMessageBatchesInfo" class="text-slate-200"></p>
    <button id="selectAnotherBatchButton" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">別のバッチを選択</button>
  </div>

  <div id="statusMessages" class="mt-4 text-sm text-slate-300 space-y-1 h-20 overflow-y-auto"></div>
</div>

<div id="customModal" class="modal">
  <div class="modal-content bg-slate-800 text-slate-100 shadow-xl">
    <p id="modalMessage" class="mb-4 text-lg"></p>
    <div class="modal-buttons">
      <button id="modalOkButton" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">OK</button>
    </div>
  </div>
</div>

<script type="module">
  // --- IMPORTANT: PASTE YOUR DEPLOYED WEB APP URL HERE ---
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxnkiPtAMQGSIFIE9SSoC-3Y9RpglEG5V90S4zBdZBRd6kVgCX8RKZPhwimfoajFNs-/exec';

  // DOM Elements
  const nameSection = document.getElementById('nameSection');
  const nameSectionInstruction = document.getElementById('nameSectionInstruction');
  const userNameInput = document.getElementById('userName');
  const sentenceBatchSelect = document.getElementById('sentenceBatch');
  const completedBatchesDisplay = document.getElementById('completedBatchesDisplay');
  const proceedToDeviceSetupButton = document.getElementById('proceedToDeviceSetupButton');

  const deviceSelectionSection = document.getElementById('deviceSelectionSection');
  const deviceSelectionPreview = document.getElementById('deviceSelectionPreview');
  const cameraSelect = document.getElementById('cameraSelect');
  const micSelect = document.getElementById('micSelect');
  const confirmDevicesAndTestButton = document.getElementById('confirmDevicesAndTestButton');
  const backToNameSetupButton = document.getElementById('backToNameSetupButton');

  const testRecordingSection = document.getElementById('testRecordingSection');
  const videoPreviewTest = document.getElementById('videoPreviewTest');
  const startStopTestButton = document.getElementById('startStopTestButton');
  const proceedToMainRecordingButton = document.getElementById('proceedToMainRecordingButton');
  const backToDeviceSelectionButton = document.getElementById('backToDeviceSelectionButton');

  const recordingSection = document.getElementById('recordingSection');
  const videoPreview = document.getElementById('videoPreview');
  const timerDisplayContainer = document.getElementById('timerDisplayContainer');
  const timerText = document.getElementById('timerText');
  const sentenceToRead = document.getElementById('sentenceToRead');
  const nextSentenceButton = document.getElementById('nextSentenceButton');
  const redoButton = document.getElementById('redoButton');
  const pauseResumeButton = document.getElementById('pauseResumeButton');
  const recordingIndicator = document.getElementById('recordingIndicator');

  const completionMessageUi = document.getElementById('completionMessageUi');
  const completionMessageBatchesInfo = document.getElementById('completionMessageBatchesInfo');
  const selectAnotherBatchButton = document.getElementById('selectAnotherBatchButton');

  const displayName = document.getElementById('displayName');
  const displayBatchInfo = document.getElementById('displayBatchInfo');
  const totalSentencesDisplay = document.getElementById('totalSentencesDisplay');
  const statusMessages = document.getElementById('statusMessages');
  const customModal = document.getElementById('customModal');
  const modalMessage = document.getElementById('modalMessage');
  const modalOkButton = document.getElementById('modalOkButton');

  // State Variables
  let userName = '';
  let currentSentenceIndex = 0;
  let mediaRecorder;
  let recordedChunks = [];
  let mainStream;
  let tempDeviceStream;
  let sentences = [];
  let userNameEntered = false;
  let batchSelected = false;
  let isPaused = false;
  let countdownInterval;
  let isFirstSentenceOfSession = true;
  let isPerformingRedo = false;
  let selectedCameraId = '';
  let selectedMicId = '';
  let isTestRecordingActive = false;
  const TEST_SENTENCE = "天気がいいから散歩しましょう。";

  // Optimization Flags & Tracking
  let hasTestBeenPerformed = false;
  let isContinuingSession = false;
  let completedBatches = [];

  // Utility Functions
  function showModal(message) { modalMessage.textContent = message; customModal.style.display = 'flex'; }
  modalOkButton.onclick = () => customModal.style.display = 'none';

  function addStatusMessage(message, type = 'info') {
    const p=document.createElement('p');p.textContent=message;
    if(type==='error')p.className='text-red-400'; else if(type==='success')p.className='text-green-400'; else p.className='text-sky-300';
    if(statusMessages.firstChild)statusMessages.insertBefore(p,statusMessages.firstChild); else statusMessages.appendChild(p);
    while(statusMessages.children.length>15)statusMessages.removeChild(statusMessages.lastChild);
  }

  function updateCompletedBatchesDisplay() {
    if (completedBatches.length > 0) {
      completedBatchesDisplay.textContent = `完了したバッチ: ${completedBatches.join(', ')}`;
      Array.from(sentenceBatchSelect.options).forEach(option => {
        if (completedBatches.includes(option.value)) {
          if (!option.dataset.originalText) {
            option.dataset.originalText = option.textContent;
          }
          option.textContent = `${option.dataset.originalText} (完了)`;
          option.disabled = true;
        } else if (option.dataset.originalText) {
          option.textContent = option.dataset.originalText;
          option.disabled = false;
        } else {
          option.disabled = false;
        }
      });
    } else {
      completedBatchesDisplay.textContent = '';
      Array.from(sentenceBatchSelect.options).forEach(option => {
        if (option.dataset.originalText) {
          option.textContent = option.dataset.originalText;
        }
        option.disabled = false;
      });
    }
  }

  function checkCanProceedToDeviceSetup() {
    if (isContinuingSession) {
      proceedToDeviceSetupButton.disabled = !batchSelected;
    } else {
      proceedToDeviceSetupButton.disabled = !(userNameEntered && batchSelected);
    }
  }

  async function stopTempDeviceStream() {
    if (tempDeviceStream) {
      tempDeviceStream.getTracks().forEach(track => track.stop());
      tempDeviceStream = null;
      if (deviceSelectionPreview) deviceSelectionPreview.srcObject = null;
    }
  }

  async function updateDeviceSelectionPreview() {
    await stopTempDeviceStream();
    const currentCamId = cameraSelect.value;
    if (!currentCamId) { if(deviceSelectionPreview) deviceSelectionPreview.srcObject = null; return; }
    try {
      const constraints = { video: { deviceId: { exact: currentCamId } }, audio: false };
      tempDeviceStream = await navigator.mediaDevices.getUserMedia(constraints);
      if (deviceSelectionPreview) deviceSelectionPreview.srcObject = tempDeviceStream;
    } catch (err) {
      addStatusMessage(`カメラプレビューエラー: ${err.message.split(':')[0]}`, "error");
      if (deviceSelectionPreview) deviceSelectionPreview.srcObject = null;
    }
  }

  async function populateDeviceSelectors() {
    addStatusMessage("デバイス一覧を取得中...", "info");
    confirmDevicesAndTestButton.disabled = true;
    cameraSelect.innerHTML = '<option value="">カメラを読込中...</option>';
    micSelect.innerHTML = '<option value="">マイクを読込中...</option>';
    let permissionGranted = false;
    try {
      const tempPermStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
      tempPermStream.getTracks().forEach(track => track.stop());
      permissionGranted = true;
      addStatusMessage("デバイス利用許可を確認しました。", "info");
    } catch (err) {
      showModal("カメラとマイクへのアクセス許可が必要です。許可されていない場合、デバイス一覧の表示や録画ができません。設定を確認し、ページを再読み込みしてください。");
      addStatusMessage("デバイス一覧表示のためのアクセス許可がありません。", "error");
      cameraSelect.innerHTML = '<option value="">アクセス許可なし</option>'; micSelect.innerHTML = '<option value="">アクセス許可なし</option>';
      return;
    }
    if (!permissionGranted) return;

    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cameras = devices.filter(d => d.kind === 'videoinput');
      const mics = devices.filter(d => d.kind === 'audioinput');

      cameraSelect.innerHTML = ''; micSelect.innerHTML = '';

      if (cameras.length > 0) {
        cameras.forEach(camera => { const option=document.createElement('option'); option.value=camera.deviceId; option.textContent=camera.label||`カメラ ${cameraSelect.options.length+1}`; cameraSelect.appendChild(option); });
        if (selectedCameraId && cameras.some(c => c.deviceId === selectedCameraId)) {
          cameraSelect.value = selectedCameraId;
        } else if (cameras.length > 0) {
          cameraSelect.selectedIndex = 0;
        }
        await updateDeviceSelectionPreview();
      } else { cameraSelect.innerHTML = '<option value="">カメラが見つかりません</option>'; }

      if (mics.length > 0) {
        mics.forEach(mic => { const option=document.createElement('option'); option.value=mic.deviceId; option.textContent=mic.label||`マイク ${micSelect.options.length+1}`; micSelect.appendChild(option); });
        if (selectedMicId && mics.some(m => m.deviceId === selectedMicId)) {
          micSelect.value = selectedMicId;
        } else if (mics.length > 0) {
          micSelect.selectedIndex = 0;
        }
      } else { micSelect.innerHTML = '<option value="">マイクが見つかりません</option>'; }

      if (cameras.length > 0 && mics.length > 0) { confirmDevicesAndTestButton.disabled = false; addStatusMessage("カメラとマイクを選択してください。", "info"); }
      else { showModal("カメラまたはマイクが見つかりません。接続を確認してください。"); addStatusMessage("カメラまたはマイクが見つかりません。", "error"); }
    } catch (err) { console.error("デバイス一覧取得エラー:", err); showModal("デバイス一覧取得エラー: " + err.message); addStatusMessage("デバイス一覧取得エラー: "+err.message, "error"); cameraSelect.innerHTML='<option value="">読込エラー</option>'; micSelect.innerHTML='<option value="">読込エラー</option>';}
  }

  cameraSelect.addEventListener('change', updateDeviceSelectionPreview);

  async function setupMedia(micIdToUse, cameraIdToUse) {
    addStatusMessage("選択されたデバイスでメディアを準備中...");
    if (mainStream) { mainStream.getTracks().forEach(track => track.stop()); mainStream = null; }
    await stopTempDeviceStream();

    try {
      const audioConstraint = micIdToUse ? { deviceId: { exact: micIdToUse } } : true;
      const videoConstraint = cameraIdToUse ? { deviceId: { exact: cameraIdToUse }, frameRate: { ideal: 30, max: 30 } } : { frameRate: { ideal: 30, max: 30 } };
      const constraints = { audio: audioConstraint, video: videoConstraint };
      addStatusMessage(`使用する制約: ${JSON.stringify(constraints)}`, "info");

      if (!micIdToUse || !cameraIdToUse) {
        showModal("デバイスIDがありません。デバイスを再選択してください。");
        addStatusMessage("マイクまたはカメラのIDがありません。", "error");
        return false;
      }
      mainStream = await navigator.mediaDevices.getUserMedia(constraints);

      const audioTracks = mainStream.getAudioTracks();
      if (audioTracks.length > 0) {
        addStatusMessage(`音声トラック確認: ${audioTracks[0].label || 'ラベルなし'} (ID: ${audioTracks[0].id})`, "success");
      } else {
        addStatusMessage("ストリームに音声トラックがありません！", "error");
        showModal("重大なエラー：選択されたマイクから音声トラックを確立できませんでした。マイク設定と許可を確認するか、別のマイクを試してください。");
        if (mainStream) mainStream.getTracks().forEach(track => track.stop()); mainStream = null;
        return false;
      }

      if (typeof MediaRecorder==='undefined') { showModal("MediaRecorderがサポートされていません。"); throw new Error("MediaRecorder not supported"); }
      const opts = { mimeType: 'video/mp4' };
      if (!MediaRecorder.isTypeSupported(opts.mimeType)) {
        opts.mimeType = 'video/webm';
        if (!MediaRecorder.isTypeSupported(opts.mimeType)) delete opts.mimeType;
      }

      if (opts.mimeType === 'video/webm') { opts.audioBitsPerSecond = 128000; }
      else if (opts.mimeType === 'video/mp4') { opts.audioBitsPerSecond = 128000; }
      addStatusMessage(`MediaRecorderオプション: ${JSON.stringify(opts)}`, "info");

      mediaRecorder = new MediaRecorder(mainStream, opts);
      addStatusMessage(`レコーダー初期化完了。タイプ: ${mediaRecorder.mimeType||'デフォルト'}`, 'success');
      mediaRecorder.ondataavailable = e => e.data.size > 0 && recordedChunks.push(e.data);
      mediaRecorder.onstop = handleRecordingStop;
      addStatusMessage("メディアの準備が完了しました。", "success");
      return true;
    } catch (err) {
      console.error("メディア準備エラー:", err);
      let detailedError = err.message; if (err.name) detailedError = `${err.name}: ${err.message}`;
      showModal("カメラ/マイク準備エラー: " + detailedError + "。別のデバイスを試すか、許可を確認してください。");
      addStatusMessage("メディア準備エラー: " + detailedError, "error");
      if(testRecordingSection) testRecordingSection.classList.add('hidden');
      if(recordingSection) recordingSection.classList.add('hidden');
      if(nameSection) nameSection.classList.add('hidden');
      if(deviceSelectionSection) deviceSelectionSection.classList.remove('hidden');
      await populateDeviceSelectors();
      return false;
    }
  }

  async function handleRecordingStop() {
    const wasRedo = isPerformingRedo; isPerformingRedo = false;
    const wasTest = isTestRecordingActive; isTestRecordingActive = false;
    const previouslySelectedBatch = sentenceBatchSelect.value;

    if (!isTestRecordingActive) {
      recordingIndicator.classList.add('hidden');
    }

    const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || 'video/webm' }); recordedChunks = [];
    const ext = mediaRecorder.mimeType?.includes('mp4') ? 'mp4' : 'webm';

    if (wasTest) {
      addStatusMessage("テスト録画完了。デバイスは正常に動作するようです。", "success");
      const testVideoFileName = `${userName}_テスト録画.${ext}`;
      const testTextFileName = `${userName}_テスト文章.txt`;
      downloadFile(blob, testVideoFileName);
      addStatusMessage(`テスト動画「${testVideoFileName}」のダウンロードを開始しました。`, "success");
      downloadFile(new Blob([TEST_SENTENCE], { type: 'text/plain' }), testTextFileName);
      addStatusMessage(`テスト文章「${testTextFileName}」のダウンロードを開始しました。`, "success");

      startStopTestButton.textContent = "テスト再実行"; startStopTestButton.disabled = false;
      proceedToMainRecordingButton.classList.remove('hidden'); proceedToMainRecordingButton.disabled = false;
      return;
    }

    if (wasRedo) {
      addStatusMessage("前回の録画は破棄されました。やり直します。", "info");
      if (currentSentenceIndex < sentences.length) {
        startRecordingInternal();
      } else {
        addStatusMessage("エラー：やり直し中に文章インデックスが範囲外になりました。", "error");
        completeRecordingSession(previouslySelectedBatch);
      }
      return;
    }

    const sentenceTextJustRecorded = sentences[currentSentenceIndex];
    addStatusMessage(`${currentSentenceIndex + 1}番目の文章の録画を停止しました。`, "info");

    const fileBase = `${userName}_batch_${previouslySelectedBatch}_sent_${currentSentenceIndex + 1}`;
    const videoFile = `${fileBase}.${ext}`; const textFile = `${fileBase}.txt`;
    downloadFile(blob, videoFile); addStatusMessage(`動画「${videoFile}」のダウンロードを開始しました。`, 'success');
    downloadFile(new Blob([sentenceTextJustRecorded], { type: 'text/plain' }), textFile); addStatusMessage(`文章「${textFile}」のダウンロードを開始しました。`, 'success');

    currentSentenceIndex++;

    if (currentSentenceIndex < sentences.length) {
      displayNextSentence();
      startRecordingInternal();
    } else {
      completeRecordingSession(previouslySelectedBatch);
    }
  }

  function startRecordingInternal() {
    if (mediaRecorder && mediaRecorder.state === "inactive" && mainStream?.active) {
      if (isTestRecordingActive) {
        if(videoPreviewTest) videoPreviewTest.srcObject = mainStream;
        recordingIndicator.classList.add('hidden');
      } else {
        if(videoPreview) videoPreview.srcObject = mainStream;
        recordingIndicator.classList.remove('hidden');
      }

      if (!isTestRecordingActive && (sentences.length === 0 || currentSentenceIndex >= sentences.length)) {
        addStatusMessage("これ以上文章がないか、文章が読み込まれていません。", "error");
        recordingIndicator.classList.add('hidden');
        if (sentences.length > 0 && currentSentenceIndex >= sentences.length) completeRecordingSession(sentenceBatchSelect.value); return;
      }
      recordedChunks = []; mediaRecorder.start(); isPaused = false;

      if (isTestRecordingActive) {
        addStatusMessage(`テスト録画を開始しました...`);
        startStopTestButton.textContent = "テスト録画停止";
        proceedToMainRecordingButton.classList.add('hidden');
      } else {
        addStatusMessage(`${currentSentenceIndex + 1}番目の文章の録画を開始しました...`);
        nextSentenceButton.textContent = `次へ＆保存 (${currentSentenceIndex + 1}/${sentences.length})`;
        nextSentenceButton.classList.remove('bg-emerald-600', 'hover:bg-emerald-700'); nextSentenceButton.classList.add('bg-red-600', 'hover:bg-red-700');
        nextSentenceButton.disabled = false;
        pauseResumeButton.textContent = "一時停止"; pauseResumeButton.disabled = false;
        pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'opacity-50'); pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
        redoButton.disabled = false;
      }
    } else {
      addStatusMessage("録画を開始できません。レコーダーが準備できていないか、ストリームが有効ではありません。", "error");
      recordingIndicator.classList.add('hidden');
      if (!mainStream?.active) showModal("カメラ/マイクストリームが有効ではありません。許可を確認してください。");
    }
  }

  function runCountdownAndStart() {
    timerDisplayContainer.classList.remove('hidden'); let count = 3; timerText.textContent = count;
    nextSentenceButton.disabled = true; pauseResumeButton.disabled = true; redoButton.disabled = true;
    recordingIndicator.classList.add('hidden');
    countdownInterval = setInterval(() => { count--; timerText.textContent = count; if (count <= 0) { clearInterval(countdownInterval); timerDisplayContainer.classList.add('hidden'); isFirstSentenceOfSession = false; startRecordingInternal(); } }, 1000);
  }

  function displayNextSentence() {
    if (currentSentenceIndex < sentences.length) {
      sentenceToRead.textContent = sentences[currentSentenceIndex];
      addStatusMessage(`${currentSentenceIndex + 1}番目の文章: 「${sentences[currentSentenceIndex].substring(0,30)}...」`);
    }
  }

  function handleNextAction() {
    if (isPaused) { showModal("録画を再開してから次に進んでください。"); return; }
    if (mediaRecorder && mediaRecorder.state === "inactive" && currentSentenceIndex === 0 && isFirstSentenceOfSession) {
      displayNextSentence();
      runCountdownAndStart();
    } else if (mediaRecorder && mediaRecorder.state === "inactive" && currentSentenceIndex === 0 && !isFirstSentenceOfSession){
      displayNextSentence();
      startRecordingInternal();
    }
    else if (mediaRecorder && (mediaRecorder.state === "recording" || mediaRecorder.state === "paused")) {
      if (mediaRecorder.state === "paused") {
        mediaRecorder.resume();
        if (!isTestRecordingActive) recordingIndicator.classList.remove('hidden');
        isPaused = false;
      }
      isPerformingRedo = false;
      mediaRecorder.stop();
    }
  }

  proceedToDeviceSetupButton.addEventListener('click', async () => {
    if (GOOGLE_SCRIPT_URL.includes('PASTE_YOUR_DEPLOYED_WEB_APP_URL_HERE')) {
        showModal("設定エラー：HTMLファイル内のGOOGLE_SCRIPT_URLを、デプロイしたGoogle Apps ScriptのURLに置き換えてください。");
        return;
    }

    recordingIndicator.classList.add('hidden');
    const sbv = sentenceBatchSelect.value;
    if (!sbv) { showModal("文章バッチを選択してください。"); return; }
    if (completedBatches.includes(sbv) && isContinuingSession) {
      showModal(`バッチ ${sbv} は既に完了しています。別のバッチを選択してください。`);
      sentenceBatchSelect.value = "";
      batchSelected = false;
      checkCanProceedToDeviceSetup();
      return;
    }

    if (!isContinuingSession) {
      userName = userNameInput.value.trim().replace(/[^a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAFー々]/g, '');
      if (!userName) { showModal("有効な参加者番号を入力してください。"); return; }
      completedBatches = [];
      updateCompletedBatchesDisplay();
    }

    // --- MODIFIED: Fetch a BATCH of 100 sentences ---
    const BATCH_SIZE = 100;
    addStatusMessage(`データベースから${BATCH_SIZE}個のユニークな文章を取得中...`, "info");
    proceedToDeviceSetupButton.disabled = true;
    proceedToDeviceSetupButton.textContent = '文章を取得中...';

    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?count=${BATCH_SIZE}`);
        if (!response.ok) {
            throw new Error(`サーバーからの応答エラー: ${response.statusText}`);
        }
        const data = await response.json();
        if (data.error) {
            throw new Error(`スクリプトエラー: ${data.error}`);
        }
        sentences = data;
    } catch (error) {
        console.error("Fetch error:", error);
        showModal(`文章の取得に失敗しました: ${error.message}。URLが正しいか、スクリプトが正しくデプロイされているか確認してください。`);
        addStatusMessage("文章の取得に失敗しました。", "error");
        proceedToDeviceSetupButton.disabled = false;
        proceedToDeviceSetupButton.textContent = 'デバイス設定へ進む';
        checkCanProceedToDeviceSetup();
        return;
    }

    proceedToDeviceSetupButton.disabled = false;
    proceedToDeviceSetupButton.textContent = 'デバイス設定へ進む';

    if (sentences.length < BATCH_SIZE) {
        addStatusMessage(`注意: データベースから取得できたユニークな文章は${sentences.length}個のみです。`, "warn");
    }
    if (sentences.length === 0) {
      showModal(`文章の取得に失敗、またはユニークな文章がありませんでした。`);
      addStatusMessage(`文章の取得に失敗しました。`, "error"); return;
    }
    addStatusMessage(`バッチ ${sbv} の ${sentences.length} 個の文章を取得しました。`, "success");
    currentSentenceIndex = 0;

    nameSection.classList.add('hidden');
    completionMessageUi.classList.add('hidden');

    if (isContinuingSession && hasTestBeenPerformed && selectedCameraId && selectedMicId) {
      addStatusMessage("既存のデバイス設定を使用して次のバッチを開始します。テストはスキップされます。", "info");
      const mediaReady = await setupMedia(selectedMicId, selectedCameraId);
      if (mediaReady) {
        recordingSection.classList.remove('hidden');
        if(videoPreview) videoPreview.srcObject = mainStream;
        isFirstSentenceOfSession = true;
        prepareRecordingScreen();
      } else {
        addStatusMessage("メディアの再準備に失敗しました。デバイスを再選択してください。", "error");
        isContinuingSession = false; hasTestBeenPerformed = false;
        completedBatches = [];
        updateCompletedBatchesDisplay();
        deviceSelectionSection.classList.remove('hidden');
        await populateDeviceSelectors();
      }
    } else {
      deviceSelectionSection.classList.remove('hidden');
      await populateDeviceSelectors();
    }
  });

  backToNameSetupButton.addEventListener('click', () => {
    stopTempDeviceStream();
    deviceSelectionSection.classList.add('hidden');
    nameSection.classList.remove('hidden');
    recordingIndicator.classList.add('hidden');
    if(isContinuingSession) {
      isContinuingSession = false;
      userNameInput.disabled = false;
      nameSectionInstruction.textContent = "ステップ1：参加者番号を入力し、文章バッチを選択してください。";
      proceedToDeviceSetupButton.textContent = "デバイス設定へ進む";
    }
    updateCompletedBatchesDisplay();
    checkCanProceedToDeviceSetup();
  });

  confirmDevicesAndTestButton.addEventListener('click', async () => {
    selectedCameraId = cameraSelect.value; selectedMicId = micSelect.value;
    if (!selectedCameraId || !selectedMicId) { showModal("カメラとマイクの両方を選択してください。"); return; }

    await stopTempDeviceStream();
    const mediaReady = await setupMedia(selectedMicId, selectedCameraId);
    recordingIndicator.classList.add('hidden');

    if (mediaReady) {
      deviceSelectionSection.classList.add('hidden');
      if (hasTestBeenPerformed) {
        addStatusMessage("テストは既に完了しています。本番録画へ進みます。", "info");
        recordingSection.classList.remove('hidden');
        if(videoPreview) videoPreview.srcObject = mainStream;
        isFirstSentenceOfSession = true;
        prepareRecordingScreen();
      } else {
        testRecordingSection.classList.remove('hidden');
        if(videoPreviewTest) videoPreviewTest.srcObject = mainStream;
        startStopTestButton.textContent = "テスト録画開始"; startStopTestButton.disabled = false;
        proceedToMainRecordingButton.classList.add('hidden'); proceedToMainRecordingButton.disabled = true;
        addStatusMessage("テスト録画の準備ができました。", "info");
      }
    } else {
      addStatusMessage("メディアの準備に失敗しました。デバイスと許可を確認してください。", "error");
    }
  });

  startStopTestButton.addEventListener('click', () => {
    if (!mediaRecorder) { addStatusMessage("MediaRecorderがテストの準備ができていません。", "error"); return; }
    if (mediaRecorder.state === 'inactive') {
      isTestRecordingActive = true;
      startRecordingInternal();
    } else if (mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      addStatusMessage("テスト録画を停止中...", "info");
    }
  });

  proceedToMainRecordingButton.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      addStatusMessage("テストを終了しています。停止するまでお待ちください。", "warn"); return;
    }
    hasTestBeenPerformed = true;
    recordingIndicator.classList.add('hidden');

    if(videoPreviewTest) videoPreviewTest.srcObject = null;
    testRecordingSection.classList.add('hidden');
    recordingSection.classList.remove('hidden');
    if(videoPreview) videoPreview.srcObject = mainStream;

    isFirstSentenceOfSession = true;
    prepareRecordingScreen();
    addStatusMessage("本番録画セッションの準備ができました。", "info");
  });

  backToDeviceSelectionButton.addEventListener('click', async () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      isTestRecordingActive = true;
      mediaRecorder.stop();
    }
    if (mainStream) { mainStream.getTracks().forEach(track => track.stop()); mainStream = null; }
    if(videoPreviewTest) videoPreviewTest.srcObject = null;
    recordingIndicator.classList.add('hidden');

    testRecordingSection.classList.add('hidden');
    deviceSelectionSection.classList.remove('hidden');
    await populateDeviceSelectors();
  });

  function prepareRecordingScreen() {
    currentSentenceIndex = 0;
    displayNextSentence();
    nextSentenceButton.textContent = "最初の文章から開始";
    nextSentenceButton.disabled = false;
    nextSentenceButton.classList.remove('bg-red-600', 'hover:bg-red-700');
    nextSentenceButton.classList.add('bg-emerald-600', 'hover:bg-emerald-700');

    pauseResumeButton.disabled = true;
    redoButton.disabled = true;
    displayBatchInfo.textContent = sentenceBatchSelect.options[sentenceBatchSelect.selectedIndex].text.replace(' (完了)', '');
    totalSentencesDisplay.textContent = sentences.length;
    displayName.textContent = userName;
    recordingIndicator.classList.add('hidden');
  }

  redoButton.addEventListener('click', () => {
    if (!mediaRecorder || isPaused || isTestRecordingActive || mediaRecorder.state === "inactive") return;
    addStatusMessage("現在の文章をやり直します。", "info");
    isPerformingRedo = true;
    if (mediaRecorder.state === "recording" || mediaRecorder.state === "paused") {
      if (mediaRecorder.state === "paused") {
        isPaused = false;
        pauseResumeButton.textContent = "一時停止";
        pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
        pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
        nextSentenceButton.disabled = false;
      }
      mediaRecorder.stop();
    }
  });

  pauseResumeButton.addEventListener('click', () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive" || isTestRecordingActive) return;
    if (!isPaused) {
      if (mediaRecorder.state === "recording") {
        mediaRecorder.pause();
        isPaused = true;
        pauseResumeButton.textContent = "再開";
        pauseResumeButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
        pauseResumeButton.classList.add('bg-green-500', 'hover:bg-green-600');
        addStatusMessage("録画を一時停止しました。", "info");
        nextSentenceButton.disabled = true;
        redoButton.disabled = true;
        recordingIndicator.classList.add('hidden');
      }
    } else {
      if (mediaRecorder.state === "paused") {
        mediaRecorder.resume();
        isPaused = false;
        pauseResumeButton.textContent = "一時停止";
        pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
        pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
        addStatusMessage("録画を再開しました。", "info");
        nextSentenceButton.disabled = false;
        redoButton.disabled = false;
        if (!isTestRecordingActive) recordingIndicator.classList.remove('hidden');
      }
    }
  });

  function completeRecordingSession(batchValueJustCompleted) {
    if (batchValueJustCompleted && !completedBatches.includes(batchValueJustCompleted)) {
      completedBatches.push(batchValueJustCompleted);
    }
    updateCompletedBatchesDisplay();

    addStatusMessage(`バッチ ${batchValueJustCompleted} のすべての文章の録画が完了しました！`, "success");
    recordingSection.classList.add('hidden');

    completionMessageBatchesInfo.innerHTML = `ご協力ありがとうございました。<br> 完了したバッチ: ${completedBatches.join(', ')}. <br> 続けるには、次の文章バッチを選択してください。`;
    completionMessageUi.classList.remove('hidden');
    recordingIndicator.classList.add('hidden');

    if (mainStream) mainStream.getTracks().forEach(track => track.stop()); mainStream = null;
    if(videoPreview) videoPreview.srcObject = null;

    isContinuingSession = true;

    if(redoButton) redoButton.disabled = true;
    if(pauseResumeButton) {
      pauseResumeButton.textContent = "一時停止";
      pauseResumeButton.disabled = true;
      pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
      pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
    }
    if(nextSentenceButton) {
      nextSentenceButton.textContent = "最初の文章から開始";
      nextSentenceButton.disabled = true;
      nextSentenceButton.classList.remove('bg-red-600', 'hover:bg-red-700');
      nextSentenceButton.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
    }
    if(countdownInterval) clearInterval(countdownInterval);
  }

  selectAnotherBatchButton.addEventListener('click', () => {
    completionMessageUi.classList.add('hidden');
    nameSection.classList.remove('hidden');
    recordingIndicator.classList.add('hidden');

    nameSectionInstruction.textContent = "ご協力ありがとうございました。続けるには、次の文章バッチを選択してください。";
    userNameInput.value = userName;
    userNameInput.disabled = true;
    sentenceBatchSelect.value = "";
    batchSelected = false;
    proceedToDeviceSetupButton.textContent = "次のバッチを開始";
    proceedToDeviceSetupButton.disabled = true;
    updateCompletedBatchesDisplay();
    checkCanProceedToDeviceSetup();
  });

  function downloadFile(blob, filename) { const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

  // Initial Event Listeners and Setup
  userNameInput.addEventListener('input', () => {
    userNameEntered = userNameInput.value.trim() !== '';
    if (!isContinuingSession && userNameEntered) {
      completedBatches = [];
      updateCompletedBatchesDisplay();
    }
    checkCanProceedToDeviceSetup();
  });
  sentenceBatchSelect.addEventListener('change', () => {
    batchSelected = sentenceBatchSelect.value !== '';
    if (batchSelected) {
      addStatusMessage(`バッチ選択: ${sentenceBatchSelect.options[sentenceBatchSelect.selectedIndex].text.replace(' (完了)','')}`, "info");
    }
    checkCanProceedToDeviceSetup();
  });
  nextSentenceButton.addEventListener('click', handleNextAction);

  document.addEventListener('keydown', (e) => {
    if (testRecordingSection && !testRecordingSection.classList.contains('hidden')) return;
    if (deviceSelectionSection && !deviceSelectionSection.classList.contains('hidden')) return;
    if (nameSection && !nameSection.classList.contains('hidden') && !proceedToDeviceSetupButton.disabled && e.key === 'Enter') {
      e.preventDefault();
      proceedToDeviceSetupButton.click();
    }
    if (recordingSection && !recordingSection.classList.contains('hidden') && !isPaused && (e.key === 'Enter' || e.code === 'Space')) {
      e.preventDefault();
      if (!nextSentenceButton.disabled) nextSentenceButton.click();
    }
  });

  // Initialize
  addStatusMessage("アプリを読み込みました。参加者番号と文章バッチを選択してください。", "info");
  updateCompletedBatchesDisplay();
  checkCanProceedToDeviceSetup();

</script>
</body>
</html>
